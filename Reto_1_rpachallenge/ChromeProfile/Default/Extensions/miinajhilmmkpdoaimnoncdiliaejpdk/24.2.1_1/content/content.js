(()=>{"use strict";const t={name:"none",level:5},e={name:"error",level:4},n={name:"warn",level:3},i={name:"info",level:2},s={name:"debug",level:1},o={name:"trace",level:0};const r=t=>t instanceof Error?JSON.parse(JSON.stringify(t,Object.getOwnPropertyNames(t))):"undefined"!=typeof Element&&t instanceof Element?JSON.parse(JSON.stringify(t,["id","className","tagName"])):t?JSON.parse(JSON.stringify(t)):{};class a{constructor(e,n=t){this.sinkPost=e,this.logLevel=n,this.post=(t,e,n,i,...s)=>{this.sinkPost(t,e,n,i,...s)}}trace(t,e,n,...i){this.shouldReportThisLogLevel(o)&&this.post(o,t,e,n,...i)}debug(t,e,n,...i){this.shouldReportThisLogLevel(s)&&this.post(s,t,e,n,...i)}info(t,e,n,...s){this.shouldReportThisLogLevel(i)&&this.post(i,t,e,n,...s)}warn(t,e,i,...s){this.shouldReportThisLogLevel(n)&&this.post(n,t,e,i,...s)}error(t,n,i,...s){this.shouldReportThisLogLevel(e)&&this.post(e,t,n,i,...s)}shouldReportThisLogLevel(t){return this.logLevel.level<=t.level}}var h;!function(t){t[t.Console=0]="Console",t[t.Sentry=1]="Sentry",t[t.BsmLoggerForwarder=2]="BsmLoggerForwarder",t[t.BackgroundLoggerForwarder=3]="BackgroundLoggerForwarder"}(h||(h={}));class c{static addSink(t,e){c.loggerSinkManager.addSink(t,e)}static getSinkManager(){return c.loggerSinkManager}}c.loggerSinkManager=new class{constructor(){this.sinks=new Map}addSink(t,e){this.sinks.has(t)||this.sinks.set(t,e)}getSink(t){return this.sinks.get(t)}clearSinks(){this.sinks.clear()}executeSinks(t,r,a,h,...c){this.sinks.forEach((l=>{var d,g,m,u,p;switch(t){case o:null===(d=l.trace)||void 0===d||d.call(l,r,a,h,...c);break;case s:null===(g=l.debug)||void 0===g||g.call(l,r,a,h,...c);break;case i:null===(m=l.info)||void 0===m||m.call(l,r,a,h,...c);break;case n:null===(u=l.warn)||void 0===u||u.call(l,r,a,h,...c);break;case e:null===(p=l.error)||void 0===p||p.call(l,r,a,h,...c)}}))}};class l{constructor(t,e=void 0,n=void 0){this.sinkManager=t,this.loggerName=e,this.correlationId=n}executeSinks(t,e,...n){this.sinkManager.executeSinks(t,this.correlationId,this.loggerName,e,...n)}trace(t,...e){this.executeSinks(o,t,...e)}debug(t,...e){this.executeSinks(s,t,...e)}warn(t,...e){this.executeSinks(n,t,...e)}info(t,...e){this.executeSinks(i,t,...e)}error(t,...n){this.executeSinks(e,t,...n)}toJSON(){return`${this.loggerName}Logger`}}function d(t=void 0,e=void 0){return new l(c.getSinkManager(),t,e)}class g{constructor(t,e=d("BackgroundCommunicator","NXTK")){this.browser=t,this.logger=e,this.onMessageListeners=[],this.onStatusListeners=[],this.connect=()=>{this.receivingPort=this.browser.runtime.connect({name:"content"}),this.receivingPort.onDisconnect.addListener((()=>{this.dispose(),this.logger.info("Disconnected.")})),this.receivingPort.onMessage.addListener(this.messageHandler)},this.messageHandler=(t,e)=>{const n=!this.isConnected()&&e;this.sendingPort=e,n&&this.notifyStatusChanged(),this.onMessageListeners.forEach((e=>e(t)))},this.dispose=()=>{var t,e,n;null===(t=this.receivingPort)||void 0===t||t.onDisconnect.removeListener(this.dispose),null===(e=this.receivingPort)||void 0===e||e.onMessage.removeListener(this.messageHandler);try{null===(n=this.receivingPort)||void 0===n||n.disconnect()}catch{}delete this.receivingPort,delete this.sendingPort}}onMessage(t){this.onMessageListeners.push(t)}onStatusChanged(t){this.onStatusListeners.push(t)}isConnected(){return void 0!==this.sendingPort}send(t){var e;try{null===(e=this.sendingPort)||void 0===e||e.postMessage(t)}catch(e){this.dispose(),this.logger.error("Failed to send message",t)}}notifyStatusChanged(){this.onStatusListeners.forEach((t=>t(this.isConnected())))}}const m=new class{constructor(t=d("Time","NXTK")){this.logger=t,this.origin=performance.timeOrigin,this.offset=0,this.measureDrift=()=>{const t=performance.now(),e=Date.now(),n=performance.now();return e-(this.origin+(t+n)/2)}}now(){return this.origin+this.offset+performance.now()}abs(t){return this.origin+this.offset+t}};class u{constructor(t,e=d("PerformanceNavigationMonitor","NXTK")){this.onEvent=t,this.logger=e,this.navigationTimingSent=!1,this.unloadHandler=()=>{this.navigationTimingSent||this.logger.warn("performance navigation timings was not received")}}start(){this.performanceObserver=new PerformanceObserver((t=>{var e;const n=null===(e=t.getEntries())||void 0===e?void 0:e[0];(null==n?void 0:n.duration)&&(this.onEvent({entryType:"navigation",timing:n,navigationUrl:n.name,contentTimestamp:m.now()}),this.navigationTimingSent=!0)})),this.performanceObserver.observe({type:"navigation",buffered:!0}),window.addEventListener("unload",this.unloadHandler,!1)}stop(){var t;null===(t=this.performanceObserver)||void 0===t||t.disconnect(),window.removeEventListener("unload",this.unloadHandler)}configure(t){}}class p{constructor(t,e=d("PerformanceResourcesMonitor","NXTK")){this.onEvent=t,this.logger=e}configure(t){}start(){this.timingObserver=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{this.onEvent({entryType:"resource",contentTimestamp:m.now(),timing:t,resourceUrl:t.name})}))})),this.timingObserver.observe({type:"resource",buffered:!0})}stop(){this.timingObserver&&(this.timingObserver.disconnect(),delete this.timingObserver)}}var v,f,y;let b,E;function w(t,e){if(t.nodeType!==Node.ELEMENT_NODE)throw new Error("Can't generate CSS selector for non-element node type.");if("html"===t.tagName.toLowerCase())return"html";const n={root:document.body,idName:t=>!0,className:t=>!0,tagName:t=>!0,attr:(t,e)=>!1,seedMinLength:1,optimizedMinLength:2,threshold:1e3,maxNumberOfTries:1e4};b={...n,...e},E=function(t,e){return t.nodeType===Node.DOCUMENT_NODE?t:t===e.root?t.ownerDocument:t}(b.root,n);let i=M(t,"all",(()=>M(t,"two",(()=>M(t,"one",(()=>M(t,"none")))))));if(i){const e=P(F(i,t));return e.length>0&&(i=e[0]),T(i)}throw new Error("Selector was not found.")}function M(t,e,n){let i=null,s=[],o=t,r=0;for(;o;){let t=D(k(o))||D(...N(o))||D(...L(o))||D(O(o))||[{name:"*",penalty:3}];const a=x(o);if("all"==e)a&&(t=t.concat(t.filter(K).map((t=>$(t,a)))));else if("two"==e)t=t.slice(0,1),a&&(t=t.concat(t.filter(K).map((t=>$(t,a)))));else if("one"==e){const[e]=t=t.slice(0,1);a&&K(e)&&(t=[$(e,a)])}else"none"==e&&(t=[{name:"*",penalty:3}],a&&(t=[$(t[0],a)]));for(let e of t)e.level=r;if(s.push(t),s.length>=b.seedMinLength&&(i=S(s,n),i))break;o=o.parentElement,r++}return i||(i=S(s,n)),!i&&n?n():i}function S(t,e){const n=P(A(t));if(n.length>b.threshold)return e?e():null;for(let t of n)if(C(t))return t;return null}function T(t){let e=t[0],n=e.name;for(let i=1;i<t.length;i++){const s=t[i].level||0;n=e.level===s-1?`${t[i].name} > ${n}`:`${t[i].name} ${n}`,e=t[i]}return n}function I(t){return t.map((t=>t.penalty)).reduce(((t,e)=>t+e),0)}function C(t){const e=T(t);switch(E.querySelectorAll(e).length){case 0:throw new Error(`Can't select any node with this selector: ${e}`);case 1:return!0;default:return!1}}function k(t){const e=t.getAttribute("id");return e&&b.idName(e)?{name:"#"+CSS.escape(e),penalty:0}:null}function N(t){const e=Array.from(t.attributes).filter((t=>b.attr(t.name,t.value)));return e.map((t=>({name:`[${CSS.escape(t.name)}="${CSS.escape(t.value)}"]`,penalty:.5})))}function L(t){return Array.from(t.classList).filter(b.className).map((t=>({name:"."+CSS.escape(t),penalty:1})))}function O(t){const e=t.tagName.toLowerCase();return b.tagName(e)?{name:e,penalty:2}:null}function x(t){const e=t.parentNode;if(!e)return null;let n=e.firstChild;if(!n)return null;let i=0;for(;n&&(n.nodeType===Node.ELEMENT_NODE&&i++,n!==t);)n=n.nextSibling;return i}function $(t,e){return{name:t.name+`:nth-child(${e})`,penalty:t.penalty+1}}function K(t){return"html"!==t.name&&!t.name.startsWith("#")}function D(...t){const e=t.filter(R);return e.length>0?e:null}function R(t){return null!=t}function*A(t,e=[]){if(t.length>0)for(let n of t[0])yield*A(t.slice(1,t.length),e.concat(n));else yield e}function P(t){return[...t].sort(((t,e)=>I(t)-I(e)))}function*F(t,e,n={counter:0,visited:new Map}){if(t.length>2&&t.length>b.optimizedMinLength)for(let i=1;i<t.length-1;i++){if(n.counter>b.maxNumberOfTries)return;n.counter+=1;const s=[...t];s.splice(i,1);const o=T(s);if(n.visited.has(o))return;C(s)&&H(s,e)&&(yield s,n.visited.set(o,!0),yield*F(s,e,n))}}function H(t,e){return E.querySelector(T(t))===e}function X(t){if(t.target instanceof Element)return Q(t.target)}function V(t){var e,n,i,s;const o=(null!==(n=null===(e=t.match(/(\d)/g))||void 0===e?void 0:e.length)&&void 0!==n?n:0)>=2,r=(null!==(s=null===(i=t.match(/([a-z][A-Z]|[A-Z][a-z])/g))||void 0===i?void 0:i.length)&&void 0!==s?s:0)>=2;return o||r}!function(t){let e;!function(t){t.Visibilitychange="visibilitychange",t.Mousedown="mousedown",t.Focus="focus",t.Blur="blur"}(e=t.Type||(t.Type={}))}(v||(v={})),function(t){t[t.Events=0]="Events",t[t.Log=1]="Log"}(f||(f={})),function(t){let e;!function(t){t[t.Start=0]="Start",t[t.Stop=1]="Stop",t[t.LogSetup=2]="LogSetup",t[t.TransactionTriggersSetup=3]="TransactionTriggersSetup",t[t.TransactionTriggersClear=4]="TransactionTriggersClear",t[t.InteractionStartDetecting=5]="InteractionStartDetecting",t[t.InteractionStopDetecting=6]="InteractionStopDetecting",t[t.StartInspector=7]="StartInspector",t[t.StopInspector=8]="StopInspector",t[t.CleanupInspector=9]="CleanupInspector",t[t.CountMatchingElements=10]="CountMatchingElements"}(e=t.Type||(t.Type={}))}(y||(y={}));const _=["svg"],B=["title","role","alt","label","type","name"];function Q(t){const e=w(t,{idName:t=>!V(t),className:t=>!V(t),tagName:t=>!_.some((e=>e===t)),attr:(t,e)=>B.some((e=>e===t))&&!(e.length>=8)});if(e)return e;d("generate-css-selector").warn("Could not generate CSS selector for element",t)}class z{constructor(t,e=d("PageInteractionMonitor","NXTK")){this.onEvent=t,this.logger=e,this.detectingMode=!1,this.onMouseDown=t=>{var e,n;let i,s;this.detectingMode&&t&&(i=X(t),t.target instanceof HTMLElement&&(s=null!==(n=null===(e=t.target.textContent)||void 0===e?void 0:e.trim())&&void 0!==n?n:void 0)),this.onEvent({entryType:"interaction",contentTimestamp:m.now(),type:"click",cssSelector:i,innerText:s})},this.monitorsOptions=[{eventName:v.Type.Mousedown,callback:this.onMouseDown,eventListenerOption:{passive:!0,capture:!0}}]}start(){this.monitorsOptions.forEach((t=>{window.addEventListener(t.eventName,t.callback,t.eventListenerOption)}))}stop(){var t;null===(t=this.monitorsOptions)||void 0===t||t.forEach((t=>window.removeEventListener(t.eventName,t.callback,t.eventListenerOption)))}configure(t){switch(t.type){case y.Type.InteractionStartDetecting:this.detectingMode=!0,this.logger.info("Enable interactions detecting");break;case y.Type.InteractionStopDetecting:this.detectingMode=!1,this.logger.info("Disable interactions detecting")}}}class J{constructor(t){this.onEvent=t,this.onVisibilityChange=()=>{const t={entryType:document.visibilityState,contentTimestamp:m.now(),url:window.location.href};this.onEvent(t)}}start(){this.onVisibilityChange(),window.addEventListener(v.Type.Visibilitychange,this.onVisibilityChange,{capture:!0,passive:!0})}stop(){window.removeEventListener(v.Type.Visibilitychange,this.onVisibilityChange,{capture:!0})}configure(t){}}class q{constructor(t,e=10,n=d("MutationMonitor","NXTK")){this.onEvent=t,this.debounceMs=e,this.logger=n,this.mutationOptions={attributes:!0,characterData:!0,childList:!0,subtree:!0},this.mutationHandler=(t,e)=>{const n={entryType:"mutation",contentTimestamp:m.now(),navigationRef:{navigationUrl:window.location.href,sanitized:!1}};this.onEvent(n)}}start(){const t=function(t,e){let n;return(...i)=>{clearTimeout(n),n=window.setTimeout((()=>t(...i)),e)}}(this.mutationHandler,this.debounceMs);this.observer=new MutationObserver(t),this.observer.observe(document,this.mutationOptions)}stop(){var t;null===(t=this.observer)||void 0===t||t.disconnect()}configure(t){}}const U={capture:!0,passive:!0};class W{constructor(t){this.postEvents=t}get nameStyle(){return"background: rgba(224, 229, 245, 0.8); border-radius: 5px; padding: 1px 4px;border: 1px solid #aabfcf; font-size: 0.95em; color: #111;"}}class Z{constructor(t){const e=t.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");this.regex=new RegExp(e)}matches(t){return this.regex.test(t)}}const j={childList:!0,subtree:!0};class G extends W{get monitoring(){return this._monitoring}constructor(t,e,n,i,s,o,r=!1,a=!1,h="",c=document.body,l=d("ElementAdditionMonitor","NXTK")){super(t),this.monitorId=e,this.transactionMonitorId=n,this.name=i,this.appId=s,this.cssSelector=o,this.waitForNew=r,this.selectAll=a,this.container=c,this.logger=l,this._monitoring=!1,this.hasFirstMutationDetected=!1,this.reportedElements=[],this.onMutation=(t,e)=>{if(!this._monitoring)return;if(!this.hasFirstMutationDetected&&!this.waitForNew&&(this.hasFirstMutationDetected=!0,this.tryDetectElement()))return void e.disconnect();const n=m.now();for(let e=0;e<t.length;e++){const i=t[e];if("childList"===i.type){const t=i.addedNodes;for(let e=0;e<t.length;e++){const i=t[e];if(i.nodeType===i.ELEMENT_NODE){const t=i;let e;try{e=t.matches(this.cssSelector)}catch(t){return this.logger.error(t),void this.stop()}if(e){if(this.checkCandidateElement(t,n))return}else if(this.findInDescendants(t,n))return}}}}},h.length>0&&(this.textPattern=new Z(h))}start(){this._monitoring||(this._monitoring=!0,!this.waitForNew&&this.tryDetectElement()||!this._monitoring||(this.mutationObserver=new MutationObserver(this.onMutation),this.mutationObserver.observe(this.container,j),this.logger.debug(`waiting for ${this.selectAll?"multiple elements":"one element"} to be added: %c${this.name}%c ${this.cssSelector}`,this.nameStyle,"")))}stop(){this._monitoring=!1,this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=void 0),this.reportedElements.length=0}tryDetectElement(){const t=m.now();let e;try{e=this.container.querySelectorAll(this.cssSelector)}catch(t){return this.logger.error(t),this.stop(),!1}if(this.textPattern&&e.length>50){this.logger.error(`%c${this.name}%c inner text pattern matching cannot be used with selectors that yield more than 50 elements`,this.nameStyle,"");const e={contentTimestamp:t,appId:this.appId,entryType:"monitor-failure",reason:"CSS selector matches too many elements",monitorId:this.monitorId,transactionMonitorId:this.transactionMonitorId,url:window.location.href};return this.postEvents([e]),this.stop(),!1}for(let n=0;n<e.length;n++){const i=e[n];if(i.nodeType===i.ELEMENT_NODE){const e=i;if(this.checkInnerText(e)&&(this.onElementFound(e,t),!this.selectAll))return!0}}return!1}findInDescendants(t,e){let n;try{n=t.querySelectorAll(this.cssSelector)}catch(t){return this.logger.error(t),this.stop(),!1}for(let t=0;t<n.length;t++){const i=n[t];if(i.nodeType===i.ELEMENT_NODE){const t=i;if(this.checkCandidateElement(t,e))return!0}}return!1}checkCandidateElement(t,e){return!!this.checkInnerText(t)&&(this.onElementAdded(t,e),!this.selectAll)}checkInnerText(t){if(this.textPattern){const e=t.textContent;return!!e&&this.textPattern.matches(e)}return!0}onElementFound(t,e){if(this.reportedElements.includes(t))return;this.reportedElements.push(t);const n={entryType:"element-found",contentTimestamp:e,target:t,monitorId:this.monitorId};this.postEvents([n])}onElementAdded(t,e){if(this.reportedElements.includes(t))return;this.reportedElements.push(t);const n={entryType:"element-added",contentTimestamp:e,target:t,monitorId:this.monitorId};this.postEvents([n])}}class Y extends W{constructor(t,e,n,i,s=d("ElementRemovalMonitor","NXTK")){super(t),this.target=e,this.monitorId=n,this.name=i,this.logger=s,this.onMutation=t=>{if(!this.monitoring)return;const e=m.now();for(let n=0;n<t.length;n++){const i=t[n];if("childList"===i.type){const t=i.removedNodes;for(let n=0;n<t.length;n++){const i=t[n];if(i===this.target||i.contains(this.target))return void this.onElementRemoved(e)}}}}}get monitoring(){return!!this.mutationObserver}start(){this.monitoring||(this.mutationObserver=new MutationObserver(this.onMutation),this.mutationObserver.observe(this.target.ownerDocument.body,{childList:!0,subtree:!0}),this.logger.debug(`waiting for %c${this.name}%c to be removed`,this.nameStyle,""))}stop(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=void 0)}onElementRemoved(t){const e={entryType:"element-removed",contentTimestamp:t,target:this.target,monitorId:this.monitorId};this.logger.info(`element was removed %c${this.name}`,this.nameStyle),this.stop(),this.postEvents([e])}}class tt extends W{constructor(t,e,n,i,s,o,r=!1,a=!1,h="",c=document.body,l=d("ElementPresenceMonitor","NXTK")){super(t),this.triggerMonitorId=e,this.transactionMonitorId=n,this.appId=i,this.name=s,this.cssSelector=o,this.waitForNew=r,this.selectAll=a,this.innerTextPattern=h,this.container=c,this.logger=l,this.removalMonitors=new Map,this.elementDetected=t=>{var e;if(!this.monitoring||this.removalMonitors.size>=50)return;const n=t[0];if("monitor-failure"===n.entryType)return this.postEvents([n]),void this.stop();if(!this.removalMonitors.has(n.target)){if(this.detectNesting(n.target))return;this.logger.info(`trigger element ${"element-found"===n.entryType?"found":"added"} %c${this.name}`,this.nameStyle,n.target);const t=new Y(this.elementRemoved,n.target,this.triggerMonitorId,this.name);this.removalMonitors.set(n.target,t),t.start(),this.postEvents([n]),50===this.removalMonitors.size&&this.logger.warn(`trigger element %c${this.name}%c has reached the limit of 50 tracked elements`,this.nameStyle,"")}this.monitoring&&!this.selectAll&&(null===(e=this.additionMonitor)||void 0===e||e.stop())},this.elementRemoved=t=>{var e;if(!this.monitoring)return;const n=t[0];this.removalMonitors.delete(n.target)||this.logger.error("Element removal monitor not found:",this.name,n.target,this.removalMonitors),this.postEvents([n]),this.monitoring&&!this.selectAll&&(null===(e=this.additionMonitor)||void 0===e||e.start())}}get monitoring(){return!!this.additionMonitor}*trackedElements(){for(const t of this.removalMonitors.values())yield t.target}get trackedElementsCount(){return this.removalMonitors.size}start(){this.monitoring||(this.additionMonitor=new G(this.elementDetected,this.triggerMonitorId,this.transactionMonitorId,this.name,this.appId,this.cssSelector,this.waitForNew,this.selectAll,this.innerTextPattern,this.container),this.additionMonitor.start())}stop(){if(this.additionMonitor){this.additionMonitor.stop(),this.additionMonitor=void 0;for(const t of this.removalMonitors.values())t.stop();this.removalMonitors.clear()}}detectNesting(t){if(this.selectAll&&this.tracksRelatedElement(t)){this.logger.error(`%c${this.name}%c cannot use a CSS sector that yields to nested trigger elements`,this.nameStyle,"",this.cssSelector);const t={contentTimestamp:m.now(),appId:this.appId,url:window.location.href,entryType:"monitor-failure",reason:"nested trigger elements",monitorId:this.triggerMonitorId,transactionMonitorId:this.transactionMonitorId};return this.postEvents([t]),this.stop(),!0}return!1}tracksRelatedElement(t){let e=t.parentElement;for(;e;){if(this.removalMonitors.has(e))return!0;e=e.parentElement}for(const e of this.removalMonitors.keys())if(t.contains(e.parentElement))return!0;return!1}}class et extends W{constructor(t,e,n,i,s,o){var r,a;if(super(t),this.transactionMonitorId=e,this.triggerConfig=n,this.appId=i,this.container=s,this.logger=o,this._monitoring=!1,this.elementPresenceChanged=t=>{if(!this.monitoring)return;const e=t[0];switch(e.entryType){case"element-added":case"element-found":this.onElementAdded(e);break;case"element-removed":this.onElementRemoved(e);break;case"monitor-failure":this.postEvents([e]),this.stop()}},!n.id)throw new Error(`The monitor id must be specified: ${n.name}`);if(!(null===(r=n.element)||void 0===r?void 0:r.cssSelector))throw new Error("The CSS selector must have a value.");this.monitorId=n.id.value,this.name=null!==(a=n.name)&&void 0!==a?a:"(unnamed)",this.cssSelector=n.element.cssSelector,this.selectAll=!!n.element.selectAll}get monitoring(){return this._monitoring}*trackedElements(){this.elementMonitor&&(yield*this.elementMonitor.trackedElements())}get trackedElementsCount(){var t,e;return null!==(e=null===(t=this.elementMonitor)||void 0===t?void 0:t.trackedElementsCount)&&void 0!==e?e:0}start(){var t;this._monitoring||(this._monitoring=!0,this.elementMonitor=new tt(this.elementPresenceChanged,this.monitorId,this.transactionMonitorId,this.name,this.appId,this.cssSelector,"waitForNew"in this.triggerConfig&&!!this.triggerConfig.waitForNew,this.selectAll,null===(t=this.triggerConfig.element)||void 0===t?void 0:t.innerTextPattern,this.container),this.elementMonitor.start(),this.onStart())}stop(){var t;this._monitoring&&(this._monitoring=!1,null===(t=this.elementMonitor)||void 0===t||t.stop(),this.elementMonitor=void 0,this.onStop())}}class nt extends W{constructor(t,e,n,i,s,o=!0,r=d("ElementClassMonitor","NXTK")){super(t),this.target=e,this.monitorId=n,this.name=i,this.className=s,this.startRemoved=o,this.logger=r,this.monitoring=!1,this.hasClass=!1,this.onMutation=(t,e)=>{if(!this.monitoring)return;const n=m.now(),i=this.target.classList.contains(this.className);this.hasClass!==i&&(this.hasClass=i,this.onClassChanged(n))}}start(){this.monitoring||(this.monitoring=!0,this.checkStartState()&&(this.logger.debug("waiting for target element",this.name,"class change:",this.className),this.mutationObserver=new MutationObserver(this.onMutation),this.mutationObserver.observe(this.target,{attributes:!0,attributeFilter:["class"]})))}stop(){var t;this.monitoring&&(this.monitoring=!1,null===(t=this.mutationObserver)||void 0===t||t.disconnect(),this.mutationObserver=void 0)}checkStartState(){const t=m.now();return this.hasClass=this.target.classList.contains(this.className),this.hasClass!==this.startRemoved||(this.onClassChanged(t),this.monitoring)}onClassChanged(t){this.hasClass?this.onClassAdded(t):this.onClassRemoved(t)}onClassAdded(t){const e={entryType:"element-class-added",contentTimestamp:t,target:this.target,monitorId:this.monitorId};this.logger.info(`Class %c${this.className}%c was added to %c${this.name}`,"font-weight: bold;","",this.nameStyle),this.postEvents([e])}onClassRemoved(t){const e={entryType:"element-class-removed",contentTimestamp:t,target:this.target,monitorId:this.monitorId};this.logger.info(`Class %c${this.className}%c was removed from %c${this.name}`,"font-weight: bold;","",this.nameStyle),this.postEvents([e])}}class it extends et{constructor(t,e,n,i,s,o=d("ClassTriggerMonitor","NXTK")){var r;if(super(t,e,n,i,s,o),this.classMonitors=new Map,this.onClassToggled=t=>{if(!this.monitoring)return;const e=t[0],n={entryType:e.entryType===(this.triggerOnRemoved?"element-class-removed":"element-class-added")?"trigger-set":"trigger-reset",appId:this.appId,contentTimestamp:e.contentTimestamp,name:this.name,monitorId:this.monitorId,transactionMonitorId:this.transactionMonitorId,url:window.location.href,sourceEntryType:e.entryType};this.postEvents([n])},"className"!==(null===(r=n.mechanism)||void 0===r?void 0:r.$case)||!n.mechanism.className.name)throw new Error(`The class name must be specified: ${n.name}`);this.className=n.mechanism.className.name,this.triggerOnRemoved=!!n.mechanism.className.triggerOnRemoved}onStart(){}onStop(){for(const t of this.classMonitors.values())t.stop();this.classMonitors.clear()}onElementAdded(t){const e=new nt(this.onClassToggled,t.target,this.monitorId,this.name,this.className,!this.triggerOnRemoved);this.classMonitors.set(t.target,e),e.start()}onElementRemoved(t){const e=this.classMonitors.get(t.target);e?(e.stop(),this.classMonitors.delete(t.target)):this.logger.error("Element class monitor not found:",this.name,t.target,this.classMonitors)}}class st{constructor(t){if(this.expression=t,this.ctrl=!1,this.alt=!1,this.shift=!1,this.meta=!1,0===t.length)throw new Error("Shortcut expression cannot be empty.");if("+"===t)this.key="+";else{const e=t.split("+");let n=e.pop();if(t.endsWith("++"))e.pop(),n="+";else if(!n)throw new Error("Invalid key in shortcut expression.");this.key=n;for(let n=0;n<e.length;n++){const i=e[n];switch(i.toLowerCase()){case"ctrl":this.ctrl=!0;break;case"alt":this.alt=!0;break;case"shift":this.shift=!0;break;case"meta":case"win":case"command":this.meta=!0;break;default:throw new Error(`Invalid key modifier: '${i}' in expression ${t}`)}}1===this.key.length&&(this.shift?this.key=this.key.toUpperCase():this.key=this.key.toLowerCase())}}matches(t){return t.key===this.key&&t.ctrlKey===this.ctrl&&t.altKey===this.alt&&t.shiftKey===this.shift&&t.metaKey===this.meta}toString(){return this.expression}}class ot{constructor(t,e,n,i=d("KeyboardShortcutMonitor","NXTK")){this.onEvent=t,this.target=n,this.logger=i,this.detectingMode=!1,this.onKeyboardEvent=t=>{this.shortcut.matches(t)&&this.onKeyboardShortcut(t)},this.shortcut=new st(e)}start(){}stop(){}startKeyboardMonitor(){var t;this.logger.debug(`listening for keyboard shortcut ${this.shortcut.toString()} on element ${null!==(t=this.target)&&void 0!==t?t:window}`),this.target?this.target.addEventListener("keydown",this.onKeyboardEvent,{passive:!0,capture:!0}):window.addEventListener("keydown",this.onKeyboardEvent,{passive:!0,capture:!0})}stopKeyboardMonitor(){this.target?this.target.removeEventListener("keydown",this.onKeyboardEvent,{capture:!0}):window.removeEventListener("keydown",this.onKeyboardEvent,{capture:!0})}configure(t){switch(t.type){case y.Type.InteractionStartDetecting:this.logger.debug("Start keyboard shortcut monitor"),this.detectingMode||this.startKeyboardMonitor(),this.detectingMode=!0;break;case y.Type.InteractionStopDetecting:this.logger.debug("Stop keyboard shortcut monitor"),this.detectingMode&&this.stopKeyboardMonitor(),this.detectingMode=!1}}onKeyboardShortcut(t){var e,n;const i=this.shortcut.toString();let s,o;this.detectingMode&&t&&(s=X(t),t.target instanceof HTMLElement&&(o=null!==(n=null===(e=t.target.textContent)||void 0===e?void 0:e.trim())&&void 0!==n?n:void 0));const r={entryType:"keyboard-shortcut",contentTimestamp:m.now(),shortcut:i,cssSelector:s,innerText:o};this.onEvent(r)}}class rt extends et{constructor(t,e,n,i,s,o=d("EventTriggerMonitor","NXTK")){var r,a;if(super(t,e,n,i,s,o),this.elementShortcutMonitors=new Map,this.onTriggerEvent=t=>{if(!this.monitoring)return;const e=m.now(),n={entryType:"trigger-set",appId:this.appId,transactionMonitorId:this.transactionMonitorId,contentTimestamp:e,name:this.triggerConfig.name,url:window.location.href,monitorId:this.monitorId};this.logger.info(`%c${this.triggerConfig.name}%c event fired on %c${this.name}`,this.nameStyle,"",this.nameStyle),this.postEvents([n])},this.onKeyboardShortcut=t=>{var e;if(!this.monitoring)return;const n={entryType:"trigger-set",appId:this.appId,contentTimestamp:t.contentTimestamp,name:"keyboardShortcut"===(null===(e=this.triggerConfig.mechanism)||void 0===e?void 0:e.$case)?this.triggerConfig.mechanism.keyboardShortcut.expression:void 0,url:window.location.href,monitorId:this.monitorId,transactionMonitorId:this.transactionMonitorId,sourceEntryType:t.entryType};this.postEvents([n])},"event"!==(null===(r=n.mechanism)||void 0===r?void 0:r.$case)&&"keyboardShortcut"!==(null===(a=n.mechanism)||void 0===a?void 0:a.$case))throw new Error(`At least the event name or the keyboard shortcut must be specified: ${n.name}`)}onStart(){}onStop(){var t;if(this.triggerConfig.name)for(const t of this.trackedElements())t.removeEventListener(this.triggerConfig.name,this.onTriggerEvent,U);for(const t of this.elementShortcutMonitors.values())t.stop();this.elementShortcutMonitors.clear(),null===(t=this.globalShortcutMonitor)||void 0===t||t.stop(),this.globalShortcutMonitor=void 0}onElementAdded(t){var e,n;if("event"===(null===(e=this.triggerConfig.mechanism)||void 0===e?void 0:e.$case)&&(t.target.addEventListener("click",this.onTriggerEvent,U),this.logger.debug(`listening for %c${this.triggerConfig.name}%c event on %c${this.name}`,this.nameStyle,"",this.nameStyle)),"keyboardShortcut"===(null===(n=this.triggerConfig.mechanism)||void 0===n?void 0:n.$case)&&this.triggerConfig.mechanism.keyboardShortcut.expression&&(this.triggerConfig.mechanism.keyboardShortcut.listenOnTargetElement||!this.globalShortcutMonitor)){const e=new ot(this.onKeyboardShortcut,this.triggerConfig.mechanism.keyboardShortcut.expression,this.triggerConfig.mechanism.keyboardShortcut.listenOnTargetElement?t.target:void 0);this.triggerConfig.mechanism.keyboardShortcut.listenOnTargetElement?this.elementShortcutMonitors.set(t.target,e):this.globalShortcutMonitor=e,e.startKeyboardMonitor()}}onElementRemoved(t){var e;"event"===(null===(e=this.triggerConfig.mechanism)||void 0===e?void 0:e.$case)&&t.target.removeEventListener("click",this.onTriggerEvent,U);const n=this.elementShortcutMonitors.get(t.target);n?(n.stopKeyboardMonitor(),this.elementShortcutMonitors.delete(t.target)):this.globalShortcutMonitor&&0===this.trackedElementsCount&&(this.globalShortcutMonitor.stop(),this.globalShortcutMonitor=void 0)}}const at=t=>"0"!==t.style.opacity&&!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length),ht={attributes:!0,attributeFilter:["style"]};class ct extends W{constructor(t,e,n,i,s=!0,o=d("ElementVisibilityMonitor","NXTK")){super(t),this.target=e,this.monitorId=n,this.name=i,this.startHidden=s,this.logger=o,this.monitoring=!1,this.visible=!1,this.onIntersectionOrStyleChanged=()=>{if(!this.monitoring)return;const t=m.now(),e=at(this.target);this.visible!==e&&(this.visible=e,this.onVisibilityChanged(t))}}start(){if(!this.monitoring&&(this.monitoring=!0,this.checkStartVisibility())){this.logger.debug(`waiting for visibility of %c${this.name}`,this.nameStyle," to change");const t={root:this.target.ownerDocument.documentElement};this.intersectionObserver=new IntersectionObserver(this.onIntersectionOrStyleChanged,t),this.intersectionObserver.observe(this.target),this.styleObserver=new MutationObserver(this.onIntersectionOrStyleChanged),this.styleObserver.observe(this.target,ht)}}stop(){var t,e;this.monitoring&&(this.monitoring=!1,null===(t=this.intersectionObserver)||void 0===t||t.disconnect(),this.intersectionObserver=void 0,null===(e=this.styleObserver)||void 0===e||e.disconnect(),this.styleObserver=void 0)}checkStartVisibility(){const t=m.now();return this.visible=at(this.target),this.visible!==this.startHidden||(this.onVisibilityChanged(t),this.monitoring)}onVisibilityChanged(t){this.monitoring&&(this.visible?this.onElementVisible(t):this.onElementHidden(t))}onElementVisible(t){const e={entryType:"element-visible",contentTimestamp:t,target:this.target,monitorId:this.monitorId};this.logger.info(`element became visible: %c${this.name}`,this.nameStyle),this.postEvents([e])}onElementHidden(t){const e={entryType:"element-hidden",contentTimestamp:t,target:this.target,monitorId:this.monitorId};this.logger.info(`element became hidden: %c${this.name}`,this.nameStyle),this.postEvents([e])}}class lt extends et{constructor(t,e,n,i,s,o=d("VisibilityTriggerMonitor","NXTK")){var r;super(t,e,n,i,s,o),this.visibilityMonitors=new Map,this.onVisibilityChanged=t=>{if(!this.monitoring)return;const e=t[0],n={entryType:(this.triggerOnHidden?"element-hidden"===e.entryType||"element-removed"===e.entryType:"element-visible"===e.entryType)?"trigger-set":"trigger-reset",appId:this.appId,contentTimestamp:e.contentTimestamp,transactionMonitorId:this.transactionMonitorId,name:this.name,url:window.location.href,monitorId:this.monitorId,sourceEntryType:e.entryType};this.postEvents([n])},this.triggerOnHidden="visibility"===(null===(r=n.mechanism)||void 0===r?void 0:r.$case)&&!!n.mechanism.visibility.triggerOnHidden}onStart(){}onStop(){for(const t of this.visibilityMonitors.values())t.stop();this.visibilityMonitors.clear()}onElementAdded(t){const e=new ct(this.onVisibilityChanged,t.target,this.monitorId,this.name,!this.triggerOnHidden);this.visibilityMonitors.set(t.target,e),e.start()}onElementRemoved(t){const e=this.visibilityMonitors.get(t.target);e?(e.stop(),this.visibilityMonitors.delete(t.target)):this.logger.error("Element visibility monitor not found:",this.name,this.monitoring,t,this.visibilityMonitors),this.onVisibilityChanged([t])}}class dt{static getType(t){var e;switch(null===(e=t.mechanism)||void 0===e?void 0:e.$case){case"event":case"keyboardShortcut":return rt;case"className":return it;default:return lt}}static create(t,e,n,i){return new(this.getType(n))(t,e,n,i,document.body)}}class gt{constructor(t,e=d("TransactionMonitorManager","NXTK")){this.onEvent=t,this.logger=e,this.triggers=new Map}start(){}stop(){this.triggers.forEach((t=>t.stop())),this.triggers.clear()}configure(t){var e;switch(t.type){case y.Type.TransactionTriggersSetup:{const e=t;e.triggerConfig.forEach((t=>{var n;if(!(null===(n=t.id)||void 0===n?void 0:n.value))return void this.logger.error("Can't set trigger. Invalid trigger id",e);if(this.triggers.has(t.id.value))return void this.logger.debug("Trigger already setup",t);this.logger.info("Setting up trigger",t);const i=dt.create((t=>this.onTrigger(t)),e.transactionId,t,e.appId);i.start(),this.triggers.set(t.id.value,i)}));break}case y.Type.TransactionTriggersClear:{const n=t;if("*"===n.monitorId){this.logger.info("Clearing all triggers",n),this.clearAllTriggers();break}if(!this.triggers.has(n.monitorId)){this.logger.warn("Can't reset trigger. Not set.",n);break}this.logger.info("Clearing trigger",n),null===(e=this.triggers.get(n.monitorId))||void 0===e||e.stop(),this.triggers.delete(n.monitorId);break}}}clearAllTriggers(){this.triggers.forEach((t=>{t.stop()})),this.triggers.clear()}onTrigger(t){if(this.logger.debug("Trigger activated",t),t.length){const e=t[0];this.onEvent(e)}}}class mt{constructor(t,e=d("InspectorMonitor","NXTK")){this.onEvent=t,this.logger=e,this.isMainFrame=window.parent.location===window.location,this.isInspectorStarted=!1,this.onMouseMove=t=>{this.screen.style.pointerEvents="none";const e=document.elementFromPoint(t.clientX,t.clientY);if(!(e instanceof HTMLElement))return;if(e instanceof HTMLIFrameElement)return void(this.highlight.style.display="none");this.focusedElement=e;const{x:n,y:i,width:s,height:o}=this.focusedElement.getBoundingClientRect();this.screen.style.pointerEvents="auto",this.highlight.style.left=`${n}px`,this.highlight.style.top=`${i}px`,this.highlight.style.width=`${s}px`,this.highlight.style.height=`${o}px`,this.highlight.style.display="block"},this.onMouseClick=t=>{if(t.stopImmediatePropagation(),!this.focusedElement)return;const e=Q(this.focusedElement);e&&(this.onEvent({contentTimestamp:m.now(),entryType:"inspector",cssSelector:e}),this.disableInspector(),this.updateSelectedElementsStyle(e))},this.onMouseOut=()=>{this.highlight.style.display="none"},this.onBlur=()=>{document.activeElement instanceof HTMLIFrameElement&&window.setTimeout((()=>{window.focus(),this.screen.style.pointerEvents="auto",this.disableInspector()}),0)},this.screen=this.createScreenElement(),this.highlight=this.createHighlightElement(),this.style=this.createStyle(),this.screen.append(this.highlight)}start(){}stop(){}configure(t){switch(t.type){case y.Type.StartInspector:this.logger.debug("Start inspector"),this.isInspectorStarted||this.startInspector(),this.isInspectorStarted=!0;break;case y.Type.StopInspector:this.logger.debug("Stop inspector"),this.isInspectorStarted&&this.stopInspector(),this.isInspectorStarted=!1;break;case y.Type.CleanupInspector:this.logger.debug("Cleanup inspector"),this.cleanup()}}startInspector(){document.head.append(this.style),document.body.append(this.screen),document.addEventListener("mouseout",this.onMouseOut,{capture:!0}),document.addEventListener("mousemove",this.onMouseMove,{capture:!0}),document.addEventListener("click",this.onMouseClick,{capture:!0}),window.addEventListener("blur",this.onBlur,{capture:!0})}stopInspector(){delete this.focusedElement,this.highlight.style.display="none",this.disableInspector(),this.screen.remove()}disableInspector(){document.removeEventListener("mouseout",this.onMouseOut,{capture:!0}),document.removeEventListener("mousemove",this.onMouseMove,{capture:!0}),document.removeEventListener("click",this.onMouseClick,{capture:!0}),window.removeEventListener("blur",this.onBlur,{capture:!0}),this.screen.style.pointerEvents="auto"}cleanup(){this.style.remove()}createStyle(){return document.createElement("style")}updateSelectedElementsStyle(t){var e;null===(e=this.style.sheet)||void 0===e||e.insertRule(`${t} {\n              background: #fdcd6c !important;\n              outline: 4px dotted #fdcd6c !important;\n           }`,0)}createScreenElement(){const t=document.createElement("div");return t.id="screen",t.style.position="fixed",t.style.zIndex="2147483647",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.cursor="copy",this.isMainFrame&&(t.style.background="rgba(0, 0, 0, 0.5)"),t}createHighlightElement(){const t=document.createElement("div");return t.style.boxSizing="content-box",t.style.position="fixed",t.style.pointerEvents="none",t.style.transition="width 0.1s, height 0.1s, top 0.1s, left 0.1s",t.style.background="rgba(253, 205, 108, 20%)",t.style.outline="4px dotted #fdcd6c",t.style.display="none",t}}class ut{constructor(t,e=d("MonitorsManager","NXTK")){this.eventCollector=t,this.logger=e,this.registeredMonitors=[],this.isMainFrame=window.parent.location===window.location,this.handleEvent=t=>{this.eventCollector.collect([t])}}registerMonitors(){this.registeredMonitors.push(new p(this.handleEvent),new q(this.handleEvent),new z(this.handleEvent),new gt(this.handleEvent),new mt(this.handleEvent),new ot(this.handleEvent,"Enter")),this.isMainFrame&&this.registeredMonitors.push(new u(this.handleEvent),new J(this.handleEvent)),this.registeredMonitors.forEach((t=>{t.start()}))}configure(t){this.registeredMonitors.forEach((e=>e.configure(t)))}}class pt extends a{constructor(e,n){super(((e,n,i,s,...o)=>{e.name!==t.name&&this.forwardLog(e,n,i,s,...o)}),n),this.postMessage=e,this.forwardLog=(t,e,n,i,...s)=>{const o={type:f.Log,level:t.name,logInfo:{correlationId:e,loggerName:n,message:r(i),additional:s.map(r)}};this.postMessage(o)}}}class vt{constructor(t,e,n=d("ContentConfigurator","NXTK")){this.monitorsManager=t,this.communicator=e,this.logger=n}register(){this.communicator.onMessage((t=>this.handleBackgroundMessage(t))),this.monitorsManager.registerMonitors()}handleBackgroundMessage(t){switch(this.logger.debug("Page Command",t),t.type){case y.Type.Start:break;case y.Type.InteractionStartDetecting:case y.Type.InteractionStopDetecting:case y.Type.TransactionTriggersSetup:case y.Type.TransactionTriggersClear:case y.Type.StartInspector:case y.Type.StopInspector:case y.Type.CleanupInspector:this.monitorsManager.configure(t);break;case y.Type.LogSetup:c.addSink(h.BackgroundLoggerForwarder,new pt((t=>{this.communicator.send(t)}),t.logLevel))}}}class ft{constructor(t,e=d("EventCollector","NXTK")){this.communicator=t,this.logger=e,this.eventsQueue=[],this.maxQueueExceededReported=!1,this.communicator.onStatusChanged((t=>{this.handleStatusChanged(t)}))}collect(t){if(t.length){if(this.communicator.isConnected())return this.logger.debug("Generated events",t),void this.postToBackground(t);this.logger.info("Not connected to the background script. Queueing events.",t),this.queueEvents(t)}}handleStatusChanged(t){if(!t)return;const e=m.now();this.logger.info("Connection established",e),this.sendQueueEventsAfterConnectionEstablish(e)}sendQueueEventsAfterConnectionEstablish(t){this.lastMutationEvent&&(this.eventsQueue.push(this.lastMutationEvent),delete this.lastMutationEvent),this.eventsQueue.length&&(this.eventsQueue.forEach((e=>e.timestampOffsetToContentConnected=t-e.contentTimestamp)),this.eventsQueue.length&&this.postToBackground(this.eventsQueue))}queueEvents(t){var e;if(this.eventsQueue.length<500){this.maxQueueExceededReported=!1,this.lastMutationEvent=null!==(e=t.find((t=>"mutation"===t.entryType)))&&void 0!==e?e:this.lastMutationEvent;const n=t.filter((t=>"mutation"!==t.entryType));this.eventsQueue.push(...n)}else this.maxQueueExceededReported||(this.logger.error("Events queue is full. Ignoring events.",500,this.eventsQueue.map((t=>t.entryType)),t),this.maxQueueExceededReported=!0)}postToBackground(t){this.communicator.send({type:f.Events,events:JSON.stringify(t)})}}"true"===String(!1).toLowerCase()&&c.addSink(h.Console,new class extends a{constructor(e){super(((e,n,i,s,...o)=>{e.name!==t.name&&console[e.name](...function(t,e,n,i){const s=`${null!=e?e:""} [${(new Date).toISOString()}] ${t.name.toUpperCase()} ${null!=n?n:""}:`;return"string"==typeof i?[`${s} ${i}`]:[s,i]}(e,n,i,s),...o)}),e)}}(o));try{const t=new g(chrome);t.connect();new vt(new ut(new ft(t)),t).register()}catch(t){console.error("NXTK: Failed to start content",t)}})();
//# sourceMappingURL=content.js.map